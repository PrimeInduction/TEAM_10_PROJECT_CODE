<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>NYC Shapefile Viewer with Search & Zoom</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f4f9;
            margin: 0;
            padding-bottom: 30px;
        }

        h1 {
            color: #333;
        }

        .map-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 20px;
            width: 100%;
        }

        .map-box {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 15px;
            text-align: center;
        }

        .map-box h2 {
            margin-top: 0;
            color: #555;
        }

        .search-box {
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            gap: 5px;
        }

        .search-box input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-box button {
            padding: 8px 12px;
            border: none;
            background-color: #4c78a8;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .search-box button:hover {
            background-color: #3b5f8a;
        }

        .zoom-controls {
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            gap: 5px;
        }

        .zoom-controls button {
            width: 30px;
            height: 30px;
            font-size: 20px;
            font-weight: bold;
            line-height: 1;
            padding: 0;
            border: 1px solid #ddd;
            background-color: #f7f7f7;
            color: #555;
            border-radius: 4px;
            cursor: pointer;
        }

        .zoom-controls button:hover {
            background-color: #e9e9e9;
        }


        svg {
            cursor: move;
            border: 1px solid #ddd;
        }

        .tracts {
            fill: #4c78a8;
            /* Blue for tracts */
            stroke: #fff;
            stroke-width: 0.2px;
            opacity: 0.8;
            transition: fill 0.3s;
        }

        .zones {
            fill: #f58518;
            /* Orange for zones */
            stroke: #fff;
            stroke-width: 0.2px;
            opacity: 0.8;
            transition: fill 0.3s;
        }

        .highlight {
            fill: #ffd700;
            /* Yellow for highlight */
        }

        path:hover {
            opacity: 1;
        }

        /* --- Tooltip Style --- */
        #tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            /* So the mouse events go 'through' the tooltip to the map */
            opacity: 0;
            transition: opacity 0.2s;
            white-space: pre-wrap;
            /* Allows line breaks */
        }
    </style>
</head>

<body>

    <h1>NYC Geographic Layers</h1>
    <div id="tooltip"></div>

    <div class="map-container">
        <div class="map-box">
            <h2>NYC Census Tracts</h2>
            <div class="search-box">
                <input type="text" id="tract-search-input" placeholder="Enter Tract ID (e.g., 36005000100)">
                <button id="tract-search-button">Search</button>
            </div>
            <div class="zoom-controls">
                <button id="tract-zoom-in">+</button>
                <button id="tract-zoom-out">-</button>
            </div>
            <div id="tract-map"></div>
        </div>
        <div class="map-box">
            <h2>NYC Taxi Zones</h2>
            <div class="search-box">
                <input type="text" id="zone-search-input" placeholder="Enter LocationID (e.g., 142)">
                <button id="zone-search-button">Search</button>
            </div>
            <div class="zoom-controls">
                <button id="zone-zoom-in">+</button>
                <button id="zone-zoom-out">-</button>
            </div>
            <div id="zone-map"></div>
        </div>
    </div>

    <script>
        const width = 500;
        const height = 500;

        // Store geojson features for searching
        let tractFeatures = [];
        let zoneFeatures = [];

        // --- Create SVG for Census Tracts ---
        const tractSvg = d3.select("#tract-map").append("svg")
            .attr("width", width)
            .attr("height", height);
        const tractGroup = tractSvg.append("g");

        // --- Create SVG for Taxi Zones ---
        const zoneSvg = d3.select("#zone-map").append("svg")
            .attr("width", width)
            .attr("height", height);
        const zoneGroup = zoneSvg.append("g");

        // --- Tooltip ---
        const tooltip = d3.select("#tooltip");

        // --- Projections ---
        const tractProjection = d3.geoIdentity();
        const zoneProjection = d3.geoIdentity();
        const tractPath = d3.geoPath().projection(tractProjection);
        const zonePath = d3.geoPath().projection(zoneProjection);

        // --- Zoom ---
        const zoom = d3.zoom()
            .scaleExtent([0.8, 80])
            .on("zoom", () => {
                const transform = d3.event.transform;
                if (d3.event.sourceEvent && d3.event.sourceEvent.target.closest('svg') === tractSvg.node()) {
                    tractGroup.attr("transform", transform);
                }
                if (d3.event.sourceEvent && d3.event.sourceEvent.target.closest('svg') === zoneSvg.node()) {
                    zoneGroup.attr("transform", transform);
                }
            });

        // Separate zoom behaviors for each SVG
        const tractZoom = d3.zoom().scaleExtent([0.8, 80]).on("zoom", () => tractGroup.attr("transform", d3.event.transform));
        const zoneZoom = d3.zoom().scaleExtent([0.8, 80]).on("zoom", () => zoneGroup.attr("transform", d3.event.transform));

        tractSvg.call(tractZoom);
        zoneSvg.call(zoneZoom);


        // --- Load and Draw Census Tracts with Tooltips ---
        d3.json("nyc_tracts/nyc_tracts.json").then(function (geojson) {
            tractFeatures = geojson.features; // Store features
            tractProjection.fitSize([width, height], geojson);

            tractGroup.selectAll("path")
                .data(geojson.features)
                .enter().append("path")
                .attr("d", tractPath)
                .attr("class", "tracts")
                .on("mouseover", function (d) {
                    tooltip.style("opacity", 1);
                    tooltip.html(`Tract ID: ${d.properties.BoroCT2020}`);
                })
                .on("mousemove", function () {
                    // BUG FIX: Check if d3.event has page coordinates. This prevents
                    // an error when a mouse event conflicts with a zoom transition event.
                    if (d3.event && typeof d3.event.pageX !== 'undefined') {
                        tooltip.style("left", (d3.event.pageX + 10) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                    }
                })
                .on("mouseout", function () {
                    tooltip.style("opacity", 0);
                });
        }).catch(handleError(tractGroup, "nyc_tracts.json"));

        // --- Load and Draw Taxi Zones with Tooltips ---
        d3.json("taxi_zones/taxi_zones.json").then(function (geojson) {
            zoneFeatures = geojson.features; // Store features
            zoneProjection.fitSize([width, height], geojson);

            zoneGroup.selectAll("path")
                .data(geojson.features)
                .enter().append("path")
                .attr("d", zonePath)
                .attr("class", "zones")
                .on("mouseover", function (d) {
                    tooltip.style("opacity", 1);
                    tooltip.html(`Zone: ${d.properties.zone}\nLocationID: ${d.properties.LocationID}`);
                })
                .on("mousemove", function () {
                    // BUG FIX: Check if d3.event has page coordinates. This prevents
                    // an error when a mouse event conflicts with a zoom transition event.
                    if (d3.event && typeof d3.event.pageX !== 'undefined') {
                        tooltip.style("left", (d3.event.pageX + 10) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                    }
                })
                .on("mouseout", function () {
                    tooltip.style("opacity", 0);
                });
        }).catch(handleError(zoneGroup, "taxi_zones.json"));


        // --- Search and Zoom Function ---
        function searchAndZoom(inputId, features, idProperty, group, pathGenerator, svg, zoomBehavior) {
            const searchId = document.getElementById(inputId).value.trim();
            if (!searchId) return;

            const foundFeature = features.find(f => String(f.properties[idProperty]) === searchId);

            // Clear previous highlights
            group.selectAll('path').classed('highlight', false);

            if (foundFeature) {
                const bounds = pathGenerator.bounds(foundFeature);
                const dx = bounds[1][0] - bounds[0][0];
                const dy = bounds[1][1] - bounds[0][1];
                const x = (bounds[0][0] + bounds[1][0]) / 2;
                const y = (bounds[0][1] + bounds[1][1]) / 2;
                const scale = Math.max(1, Math.min(50, 0.9 / Math.max(dx / width, dy / height)));
                const translate = [width / 2 - scale * x, height / 2 - scale * y];

                const transform = d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale);

                svg.transition()
                    .duration(750)
                    .call(zoomBehavior.transform, transform);

                // Highlight the found path
                const selectedPath = group.selectAll('path').filter(d => String(d.properties[idProperty]) === searchId);
                selectedPath.classed('highlight', true);

                // Remove highlight after a delay
                setTimeout(() => {
                    selectedPath.classed('highlight', false);
                }, 2500);


            } else {
                alert("ID not found.");
            }
        }

        // --- Event Listeners for Search Buttons ---
        d3.select("#tract-search-button").on("click", () => {
            searchAndZoom('tract-search-input', tractFeatures, 'BoroCT2020', tractGroup, tractPath, tractSvg, tractZoom);
        });

        d3.select("#zone-search-button").on("click", () => {
            searchAndZoom('zone-search-input', zoneFeatures, 'LocationID', zoneGroup, zonePath, zoneSvg, zoneZoom);
        });

        // --- Event Listeners for Zoom Buttons ---
        const zoomFactor = 1.3; // How much to zoom in/out

        d3.select("#tract-zoom-in").on("click", () => {
            tractSvg.transition().duration(250).call(tractZoom.scaleBy, zoomFactor);
        });
        d3.select("#tract-zoom-out").on("click", () => {
            tractSvg.transition().duration(250).call(tractZoom.scaleBy, 1 / zoomFactor);
        });

        d3.select("#zone-zoom-in").on("click", () => {
            zoneSvg.transition().duration(250).call(zoneZoom.scaleBy, zoomFactor);
        });
        d3.select("#zone-zoom-out").on("click", () => {
            zoneSvg.transition().duration(250).call(zoneZoom.scaleBy, 1 / zoomFactor);
        });


        // Helper function for handling file loading errors
        function handleError(group, filename) {
            return function (error) {
                console.error(`Error loading ${filename}:`, error);
                group.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .text(`Could not load ${filename}`);
            }
        }

    </script>

</body>

</html>